\documentclass[12pt,a4paper]{jreport}

\pagestyle{headings}
\topmargin 0mm
\oddsidemargin 5mm
\textwidth 150mm
\textheight 230mm

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{siunitx}
\sisetup{detect-all}

\title{平成28年　卒業研究論文\\
    　\\
    　\\
    　\\
\huge\bf 疑似ラインセンサーを用いた\\ＳＰレコード音検出\\}
\author{　\\
    　\\
    北海学園大学工学部 電子情報工学科\\
    魚住研究室\\
    \\
    \\
    4513213\\
クーン・トビアス}
\date{2016年10月11日}



\begin{document}
\maketitle
\tableofcontents



\chapter{はじめに}




\chapter{画像データ生成}
\section{実験装置}

SPレコードの撮像に用いられる実験装置を図\ref{fig:experimentalSetup}に示す．レコードに下にあるパルスステージはレコードをカメラの位置に対して平行に
（図\ref{fig:experimentalSetup}で言うと左右に）動かす．この平行移動をパルスモータFが実装する回転運動と組み合わせると，SPレコードの全領域を顕微鏡の下
に持ってこられる仕組みができる．


\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{experimentalSetup.eps}
        \caption{実験装置の設定}
        \label{fig:experimentalSetup}
    \end{center}
\end{figure}

\begin{table}[h]
    \begin{center}
        \begin{tabular}{ l l }
            A & CDDカメラ \\
            B & 顕微鏡 \\
            C & 照射装置 \\
            D & SPレコード \\
            E & パルスモータ、平行移動用 \\
            F & パルスモータ、回転用 \\
        \end{tabular}
    \end{center}
\end{table}

\subsection{接続図}
それぞれの実験装置がどのようにしてパソコンと繋がっているかを図\ref{fig:ElectricalSetup}に示す．GigEバスはパソコンのNIC（Network Interface Card）と接続される．


\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{ElectricalSetup.eps}
        \caption{実験装置の設定}
        \label{fig:ElectricalSetup}
    \end{center}
\end{figure}

\subsection{CCDカメラ}
本研究で使用されているカメラはJAI社の「BB-500GE」である．
カメラの最大解像度は2456(h)x2058(v)であるが，Variable Partial Scan機能を利用して実際にデータとしてパソコンに送られるのはもっと幅が狭い領域のデータである．
表\ref{table:JAI}にカメラのパラメータの設定を示す．

\begin{table}[h]
    \begin{center}
        \caption{JAI BB-500GEのパラメータの設定}
        \label{table:JAI}
        \begin{tabular}{ | l | l |}
            \hline
            ROI範囲設定 & 2456 (h) x 32 (v) \\ \hline
            GainRaw & 550 \\ \hline
            ExposureTimeRaw & 222 \\ \hline
            AcquisitionMode & Continuous \\ \hline
            ExposureMode & EdgePreSelect \\ \hline
            PartialScan & Variable Partial Scan \\ \hline
            VariablePartialScanStartLine & 1013 \\ \hline
            VariablePartialScanNumOfLines & 32 \\ \hline
            TriggerSelector & FrameStart \\ \hline
            TriggerMode & On \\ \hline
            TriggerSource & Software \\ \hline
            LineSelector & CameraTrigger0 \\ \hline
            LineSource & SoftwareTrigger0 \\ \hline
            LineInverter & ActiveHight \\ \hline
        \end{tabular}
    \end{center}
\end{table}

画像データ生成段階でSPレコードを一定の速度で回転させながら順次に撮像を行うため，
ExposureTimeRawパラメータ（無単位）は実験的にぶれが生じないように設定した．表\ref{table:JAI}のパラメータは全て自作のC\#プログラムで設定される．
SoftwareTriggerを実行して画像一枚取得するためのコードを図\ref{fig:Trigger}に示す．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{Trigger.eps}
        \caption{C\#プログラムの中からカメラのSoftwareTriggerを実行させるためのコード}
        \label{fig:Trigger}
    \end{center}
\end{figure}

\subsection{パルスステージ}
パルスステージの仕様を図\ref{table:PulseStage}に示す．

\begin{table}[h]
    \begin{center}
        \caption{パルスステージの仕様}
        \label{table:PulseStage}
        \begin{tabular}{ | l | l |}
            \hline
            degrees per pulse（回転運動） & 0.0025 \\ \hline
            mm per pulse（平行移動） & 0.002 \\ \hline
        \end{tabular}
    \end{center}
\end{table}

\section{音溝形態と光照射}
顕微鏡を通って撮像される光からSPレコードの音溝に記録されたデータを復元するのが本研究目標であるから，
撮像されるデータに音溝の形態が何らかの方法で読み取れなければならない．これを成し遂げるために，
光を斜めに照射して，音溝の壁の一部が明るく映るようにするのが有力な方法であることが過去の研究でわかった（ref!）．
図\ref{fig:ReflectionOnSPRec}に光の反射具合を模式的に表す．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{ReflectionOnSPRec.eps}
        \caption{反射の仕方}
        \label{fig:ReflectionOnSPRec}
    \end{center}
\end{figure}

図\ref{fig:ReflectionOnSPRec}を見てわかるように，SP盤に対して垂直に反射する光は，音溝の壁部分が一番多い．
一方，音溝以外の平面部分で反射する光は垂直に反射せず，顕微鏡にはほとんど入らない．この設定でカメラと顕微鏡で撮像した画像を図\ref{fig:SprecMicroscopeImgLabeled}に示す．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.6\textwidth, clip]{SprecMicroscopeImgLabeled.eps}
        \caption{SprecMicroscopeImgLabaled}
        \label{fig:SprecMicroscopeImgLabeled}
    \end{center}
\end{figure}

\section{プログラム構造}

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{ProgSetupOld.eps}
        \caption{Prog Setup Old}
        \label{fig:ProgSetupOld}
    \end{center}
\end{figure}

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{ProgSetupNew.eps}
        \caption{Prog Setup New}
        \label{fig:ProgSetupNew}
    \end{center}
\end{figure}

\chapter{画像データの前処理}
画像処理を駆使して音溝から音データを抽出するためには，
画像上の音溝データが連続的で，余分な重複などがないものでなければならない．
四角形の画像を撮影するカメラでその下を回る円盤の表面を撮像するときに，どのような問題が起きるかを調べて，解析する．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{OverlapProblem_1.eps}
        \caption{撮像の様子を幾何学的に表した図}
        \label{fig:OverlapProblem_1}
    \end{center}
\end{figure}

図\ref{fig:OverlapProblem_1}において，四角形ABCDがカメラの撮像範囲，SがSPレコードの外側，MがSPレコードの中心，$\alpha$が次の画像を取るための回転角度だとする．
また$\overline{EG} = \overline{GF}$である．

\section{重複部分問題}

図\ref{fig:OverlapProblem_2}の四角形A，B，Cが順番に撮像された画像範囲だとする．このとき，それぞれの撮像範囲が重なることがわかる．撮像範囲が
四角形であることを前提とすると，画像をどのように撮像しても重複部分，または情報損失が生じる．
音溝から音を抽出する画像処理段階で，情報損失があってはならない．重複部分も画像処理を困難にするから何らかの方法でそれを最低限に抑える必要がある．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{OverlapProblem_2.eps}
        \caption{A，B，Cと順番に撮像を行った際に重複部分が生じる}
        \label{fig:OverlapProblem_2}
    \end{center}
\end{figure}

本研究では，撮像範囲の幅（図\ref{fig:OverlapProblem_3}中$\overline{AB} = \overline{CD}$）を小さくすることで重複部分の影響を無視できる程度に抑える．
どのくらいの幅であれば無視できるといえるかを調べる．図\ref{fig:OverlapProblem_3}中の$\epsilon$が一画像の片方の重複部分だとする．隣り合っている画像でのピクセルの重複部分を
考えると$2\epsilon$となる．

$\epsilon$を求めるために，まず直角三角形MCFより$\displaystyle \frac{\alpha}{2}$を求めておく．

\begin{equation}
    \label{eq:Overlap1}
    \frac{\alpha}{2} = \arctan{\left(\frac{\overline{BE}}{\overline{MF}}\right)}
\end{equation}

$\frac{\alpha}{2}$を用いて以下の方程式が成り立つ．

\begin{equation}
    \label{eq:Overlap2}
    \overline{BE} - \overline{BG} = \tan{\left(\frac{\alpha}{2}\right)}\overline{ME}
\end{equation}

\begin{equation}
    \label{eq:Overlap3}
    \epsilon = \overline{BG} = \overline{BE} - \tan{\left(\frac{\alpha}{2}\right)}\overline{ME}
\end{equation}

式\ref{eq:Overlap1}を式\ref{eq:Overlap3}に代入し式を整理すると

\begin{equation}
    \label{eq:Overlap4}
    \epsilon = \overline{BE} \left( 1 - \frac{\overline{ME}}{\overline{MF}} \right)
\end{equation}

が得られる．本研究で作成したC\#プログラムの中のキャリブレーション機能を利用した後のパルスステージだと，変数$\overline{BE}$，$\overline{ME}$と$\overline{MF}$は
常に把握できていることから，SPレコードの任意の位置においての$\epsilon$を求めることができる．$\epsilon$の性質を調べるために，まずカメラの最大解像度で撮像を行ったときの
計算を進めてみる．ただし，撮像場所においてはSPレコードの一番外側と内側と２つのケースに分けることにする．カメラに直結している顕微鏡の拡大率が1.5xに設定してあるときの次の定数を計算に用いる．

\begin{equation}
    \label{eq:Overlap5}
    \gamma = 0.002366 \left[\frac{\si{mm}}{\si{pixel}}\right]
\end{equation}
  
\begin{equation}
    \label{eq:Overlap6}
    \delta = 422.65 \left[\frac{\si{pixel}}{\si{mm}}\right]
\end{equation}

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{OverlapProblem_3.eps}
        \caption{重複問題を数値化する$\rho$の幾何学的図}
        \label{fig:OverlapProblem_3}
    \end{center}
\end{figure}

最大解像度で撮像した画像は実際のサイズは
   
\begin{equation}
    \label{eq:Overlap7}
    \verb|height| = \overline{EF} = 5.81 \left[\si{mm}\right]
\end{equation}

\begin{equation}
    \label{eq:Overlap8}
    \verb|width| = 2\cdot\overline{BE} = 4.87 \left[\si{mm}\right]
\end{equation}

となり，またレコードの外側で撮像したときの$\overline{ME}$は

\begin{equation}
    \label{eq:Overlap9}
    \overline{ME} = 120.0 \left[\si{mm}\right]
\end{equation}

となる．$\displaystyle \overline{MF} = \overline{ME} + \overline{EF}$を考慮しながら式\ref{eq:Overlap7}，\ref{eq:Overlap8}，\ref{eq:Overlap9}を式\ref{eq:Overlap4}に代入して計算すると

\begin{equation}
    \label{eq:Overlap10}
    \epsilon_{1} = 0.1124 \left[\si{mm}\right]
\end{equation}

となり，式\ref{eq:Overlap6}の単位換算定数$\delta$をかけると
  
\begin{equation}
    \label{eq:Overlap11}
    \epsilon_{1} = 47.52 \left[\si{pixel}\right]
\end{equation}

という結果が得られる．同様にSPレコードの内側での$\rho$を$\overline{ME} = 50.0\left[\si{mm}\right] $として求めると

\begin{equation}
    \label{eq:Overlap12}
    \epsilon_{2} = 0.2534 \left[\si{mm}\right] = 107.14 \left[\si{pixel}\right]
\end{equation}

となる．ここで，前述したように，隣り合っている画像の隣接重複距離が$2\epsilon$であることを思い出すと最悪の場合の隣接重複距離が
 
\begin{equation}
    \label{eq:Overlap13}
    2\epsilon_{2} = 0.5068 \left[\si{mm}\right] = 214.28 \left[\si{pixel}\right]
\end{equation}
 
となり，これだけのピクセル数の情報が重複していると無視できない問題と判断せざるを得ない．
しかしながら，上記の計算は画像の縦幅$\displaystyle \overline{AB} = \overline{DC}$がカメラの最大解像度設定にしてある際の$\epsilon_{3}$の計算結果．
縦幅32ピクセルに指定した際の計算は位下の通りになる．

\begin{equation}
    \label{eq:Overlap14}
    \verb|width| = 2\cdot\overline{BE} = 0.0378 \left[\si{mm}\right]
\end{equation}

\begin{equation}
    \label{eq:Overlap15}
    2\epsilon_{3} = 0.00782 \left[\si{mm}\right] = 3.331 \left[\si{pixel}\right]
\end{equation}

式\ref{eq:Overlap15}の結果は最悪条件の下で計算したものであることを考慮しながら，実際の撮像データで幅3ピクセルの音溝に大きい変化があり得ないことが確認でき，このくらいの重複であれば無視してもいいと判断できる．

\section{湾曲問題}

SPレコードに刻まれた音溝がらせん状にレコードの中心へと近づいていく仕組みであるからレコードの任意の位置で音溝の形態を撮像した際にそれが湾曲していることが画像情報に残される．
複数の連続的に撮像された画像を並べてみると音溝の湾曲成分が周期的な上下振動として残り，音検出段階でこのゆっくりとした振動が間違って音情報として検出されることを防ぐために，湾曲の影響を最低限に抑える必要がある．

\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{CurveProblem.eps}
        \caption{音溝湾曲を数値化した変数$\rho$}
        \label{fig:CurveProblem}
    \end{center}
\end{figure}

図\ref{fig:CurveProblem}において，四角形ABCDがカメラの撮像範囲，TがSPレコードの音溝，MがSPレコードの中心，$\alpha$が次の画像を取るための回転角度だとする．
また，$\overline{FG} = \overline{GE}$，角$MGF$は直角である．


\begin{equation}
    \label{eq:CurveProblem1}
    \overline{GF} = \frac{1}{2}\overline{AB}
\end{equation}

\begin{equation}
    \label{eq:CurveProblem2}
    \frac{\alpha}{2} = \arctan{\left(\frac{\overline{GF}}{\overline{MF}}\right)}
\end{equation}

\begin{equation}
    \label{eq:CurveProblem3}
    \overline{MG} = \cos{\left(\frac{\alpha}{2}\right)}\overline{MF}
\end{equation}

\begin{equation}
    \label{eq:CurveProblem4}
    \rho = \overline{MH} - \overline{MG}
\end{equation}

式\ref{eq:CurveProblem1}〜式\ref{eq:CurveProblem4}より

\begin{equation}
    \label{eq:CurveProblem5}
    \rho = \overline{MH} \left\{1-\cos{\left[\arctan{\left(\frac{\overline{AB}}{2\overline{MH}}\right)}\right]}\right\}
\end{equation}

重複問題の計算と同様にレコードの一番外側と内側で$\rho$を求めることにする．まず，画像の横幅を32ピクセルと設定し，実際の画像幅を

\begin{equation}
    \label{eq:CurveProblem6}
    \verb|width| = \overline{AB} = 0.0378 \left[\si{mm}\right]
\end{equation}

と置いておく（単位換算には式\ref{eq:Overlap6}の$\gamma$を用いる）．レコードの外側だと

\begin{equation}
    \label{eq:CurveProblem7}
    \overline{MH} = 120.0 \left[\si{mm}\right]
\end{equation}

になる．このときの湾曲問題係数$\rho$は

\begin{equation}
    \label{eq:CurveProblem8}
    \rho_{1} = 0.001488 \left[\si{\micro\metre}\right] = 0.000629 \left[\si{pixel}\right]
\end{equation}

レコードの内側では

\begin{equation}
    \label{eq:CurveProblem9}
    \overline{MH} = 50.0 \left[\si{mm}\right]
\end{equation}

なので，湾曲問題係数は

\begin{equation}
    \label{eq:CurveProblem10}
    \rho_{2} = 0.03572 \left[\si{\micro\metre}\right] = 0.0015 \left[\si{pixel}\right]
\end{equation}

となる．比較のため，以下に悪条件（レコードの内側での撮像）のもとで画像幅2058ピクセル（$\overline{AB} = 4.87 \left[\si{mm}\right]$）のときの湾曲問題係数を示す．

\begin{equation}
    \label{eq:CurveProblem10}
    \rho_{3} = 59.18 \left[\si{\micro\metre}\right] = 25.0 \left[\si{pixel}\right]
\end{equation}

以上の計算より，横幅32ピクセルで画像撮像を行った場合の湾曲問題による影響が極めて小さく，無視できる程度であることがわかる．


\section{うねり問題}
\iffalse 
\begin{figure}[h]
    \begin{center}
        \includegraphics[width=0.9\textwidth, clip]{UnariProblem.eps}
        \caption{うなり}
        \label{fig:Unari}
    \end{center}
\end{figure}
\fi
\chapter{音検出アルゴリズム}

\end{document}




